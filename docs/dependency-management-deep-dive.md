# Dependency Management Deep Dive (SwiftPM + FountainAI)

This guide explains how tutorial apps depend on the FountainAI monorepo using Swift Package Manager (SwiftPM), what each profile includes, and how resolution, pinning, and updates work.

## SwiftPM Basics
- Package: A project with `Package.swift` describing products (binaries) and targets (modules).
- Dependency: Another package added via `.package(url: ..., version/branch/revision)`.
- Product: A library or executable a target can depend on (e.g., `LLMGatewayAPI`).
- Resolution: SwiftPM fetches dependencies and builds only referenced targets and their transitives.

## How Tutorials Use FountainAI
- Local mode (`./setup.sh`): Generates a minimal app (no external deps) for fast loops and unit tests.
- Upstream mode (`./setup.sh --upstream`): Copies a scaffolded `main.swift` and generates a local `Package.swift` that points to the FountainAI monorepo.
- Profiles (`--profile <name>`): Select which client libraries your target depends on; SwiftPM builds only those and their transitives.

## Profiles → Modules
- basic: no external modules.
- ai: `FountainAICore`, `FountainAIAdapters`, `LLMGatewayAPI`.
- persist: `PersistAPI`, `FountainStoreClient` (plus core/adapters).
- midi2: `MIDI2Models`, `MIDI2Core`, `SSEOverMIDI`, `FlexBridge`.
- capstone: union of ai + persist + midi2.
- full-client: `GatewayAPI`, `LLMGatewayAPI`, `PersistAPI`, `SemanticBrowserAPI` (plus core/adapters).

## Versioning & Pinning
- Default: `main` branch of FountainAI for rapid iteration.
- Stable builds: pin a tag or commit in `Package.swift`:
  - Tag: `.package(url: "...", from: "1.2.3")`
  - Commit: `.package(url: "...", revision: "<sha>")`
- `Package.resolved` is generated by SwiftPM; commit it to lock transitive versions.

## Build, Run, Test
- Build: `swift build` compiles your app and required modules.
- Run: `swift run` executes the app.
- Tests: `swift test` runs XCTest targets; all tutorials scaffold tests by default.
- Xcode: `xed .` opens the package; Xcode uses the same resolution.

## Updates & Caching
- Update FountainAI: `swift package update` (or bump the version in `Package.swift`).
- Cache: SwiftPM caches downloads/builds; only changed targets rebuild when you switch profiles.

## Troubleshooting
- Missing modules: ensure you used a profile that includes the needed products and re-run `./setup.sh --profile <name> --upstream`.
- Build fails on macOS: install Xcode CLT and accept the license; try `xcodebuild -runFirstLaunch`.
- Network issues: retry after connectivity restores; SwiftPM resumes from cache when possible.

### Package Override Identity Mismatch (SwiftPM)

Symptom (in CI or local):

> unable to override package 'FountainStore' because its identity 'fountain-store' doesn't match override's identity (directory name) '03-data-persistence-fountainstore'

Why:
- SwiftPM uses the last path component to determine a package’s identity for local overrides. The directory name must match the dependency identity. For FountainStore, the identity is `fountain-store`.

Fix options:
- Rename the override directory to match the identity, or create a symlink with the correct name and point your override path to it.
  - Example symlink:
    - `ln -s "$PWD/tutorials/03-data-persistence-fountainstore" "$PWD/../fountain-store"`
    - Update your override path to `../fountain-store`.
- Update the path in your manifest (or workspace override) to reference the correctly named directory:
  - Instead of `../03-data-persistence-fountainstore`, use `../fountain-store`.

CI helper snippet (GitHub Actions):

```yaml
- name: Prepare SwiftPM overrides
  run: |
    ln -s "$GITHUB_WORKSPACE/tutorials/03-data-persistence-fountainstore" "$GITHUB_WORKSPACE/overrides/fountain-store" || true
```

Summary: the override directory name must equal the dependency identity (`fountain-store`). Rename the directory or point your override to a correctly named directory/symlink.

## Rationale
- Profiles keep tutorial builds fast and focused while enabling deeper integration when needed.
- App-facing modules avoid server executables and plugins unless you explicitly opt in.
